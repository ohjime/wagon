<div class="w-full"
     x-data="tripFilter()"
     x-init="init()"
     x-cloak>
    <style>
        [x-cloak] {
            display: none !important
        }
    </style>
    <!-- Date button + calendar dropdown (keeps original strip below) -->
    <div class="relative inline-block w-full">
        <!-- Date Filter -->
        <div class="flex flex-row py-2">
            <!-- Date Picker -->
            <button @click="showCalendar = !showCalendar"
                    :aria-expanded="showCalendar"
                    x-ref="dateInputButton"
                    class="!pr-0 flex flex-row btn btn-ghost ">
                <div class="text-2xl font-medium font-sans"
                     x-html="formatDate(selectedDate)">
                </div>
                <svg xmlns="http://www.w3.org/2000/svg"
                     height="48px"
                     viewBox="0 -960 960 960"
                     width="48px">
                    <path d="M480-360 280-559h400L480-360Z" />
                </svg>
            </button>
            <!-- Dropdown panel -->
            <div x-show="showCalendar"
                 x-transition.opacity
                 @click.outside="showCalendar = false"
                 class="absolute z-50 mt-2 right-0">
                <calendar-date class="cally bg-base-100 border border-base-300 shadow-lg rounded-box" :value="selectedDateString" @change="onCalendarChange($event)" @input="onCalendarChange($event)">
                <svg aria-label="Previous"
                     class="fill-current size-4"
                     slot="previous"
                     xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24">
                    <path fill="currentColor" d="M15.75 19.5 8.25 12l7.5-7.5">
                    </path>
                </svg>
                <svg aria-label="Next"
                     class="fill-current size-4"
                     slot="next"
                     xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24">
                    <path fill="currentColor" d="m8.25 4.5 7.5 7.5-7.5 7.5">
                    </path>
                </svg>
                <calendar-month></calendar-month>
                </calendar-date>
            </div>
        </div>
        <!-- Search and Status Filters -->
        <div class="flex flex-row w-full">
            <!-- Search Bar -->
            <label class="input">
                <svg class="h-[1em] opacity-50"
                     xmlns="http://www.w3.org/2000/svg"
                     viewBox="0 0 24 24">
                    <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3">
                    </path>
                    </g>
                </svg>
                <input type="text"
                       required
                       name="search"
                       value="{{ request.GET.search }}"
                       placeholder="Search Trips"
                       x-model.debounce.300ms="selectedText"
                       @input="onSearchInput($event)">
            </label>
            <i class="mx-2 htmx-indicator fa fa-spinner fa-pulse"></i>
            <span class="loading loading-spinner text-success htmx-indicator"
                  id="spinner"></span>
            <div class="flex-1">
            </div>
            <!-- Status Filter -->
            <form class="filter gap-y-2"
                  @reset="onFormReset($event)">
                <input class="btn mx-4 bg-gray-400 hover:bg-gray-500 border-gray-400 hover:border-gray-500 text-white"
                       type="radio"
                       name="status"
                       value="scheduled"
                       aria-label="Scheduled"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-indigo-400 hover:bg-indigo-500 border-indigo-400 hover:border-indigo-500 text-white"
                       type="radio"
                       name="status"
                       value="assigned"
                       aria-label="Assigned"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-purple-400 hover:bg-purple-500 border-purple-400 hover:border-purple-500 text-white"
                       type="radio"
                       name="status"
                       value="en_route"
                       aria-label="En Route"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-cyan-400 hover:bg-cyan-500 border-cyan-400 hover:border-cyan-500 text-white"
                       type="radio"
                       name="status"
                       value="arrived"
                       aria-label="Arrived"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-orange-400 hover:bg-orange-500 border-orange-400 hover:border-orange-500 text-white"
                       type="radio"
                       name="status"
                       value="in_progress"
                       aria-label="In Progress"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-red-400 hover:bg-red-500 border-red-400 hover:border-red-500 text-white"
                       type="radio"
                       name="status"
                       value="canceled"
                       aria-label="Canceled"
                       x-model="selectedStatus" />
                <input class="btn mx-4 bg-green-400 hover:bg-green-500 border-green-400 hover:border-green-500 text-white"
                       type="radio"
                       name="status"
                       value="completed"
                       aria-label="Completed"
                       x-model="selectedStatus" />
                <input class="btn btn-square ml-2"
                       type="reset"
                       value="Ã—" />
            </form>
        </div>
    </div>
    <!-- Alpine + component inline for this template -->
    <script defer
            src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        function tripFilter() {
            return {
                // UI state
                showCalendar: false,
                // Filters
                selectedDate: null,
                selectedDateString: '',
                selectedStatus: null,
                selectedText: '',

                init() {
                    // Preselect today and immediately filter to today's trips
                    const now = new Date();
                    this.selectedDate = now; // display today's date
                    this.selectedDateString = this.toYmd(now); // activate date filter
                    // Accessibility: close calendar with Escape
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') this.showCalendar = false;
                    });
                    // React to status selection changes
                    this.$watch('selectedStatus', () => this.emit());
                    // Kick off initial load with today's filter
                    this.$nextTick(() => this.emit());
                },

                // Formatting helpers
                toYmd(date) {
                    if (!date) return '';
                    const tzOffset = date.getTimezoneOffset() * 60000;
                    const localISO = new Date(date.getTime() - tzOffset).toISOString();
                    return localISO.split('T')[0];
                },
                ordinalSuffix(n) {
                    const v = n % 100;
                    if (v >= 11 && v <= 13) return 'th';
                    switch (n % 10) {
                        case 1:
                            return 'st';
                        case 2:
                            return 'nd';
                        case 3:
                            return 'rd';
                        default:
                            return 'th';
                    }
                },
                formatDate(date) {
                    if (!date) return 'Select date';
                    const month = date.toLocaleString(undefined, {
                        month: 'long'
                    });
                    const day = date.getDate();
                    const year = date.getFullYear();
                    const suffix = this.ordinalSuffix(day);
                    return `${month} ${day}<sup>${suffix}</sup>, ${year}`;
                },
                parseDateMaybe(val) {
                    if (!val) return null;
                    if (val instanceof Date) return val;
                    // Handle YYYY-MM-DD
                    if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
                        const [y, m, d] = val.split('-').map(Number);
                        return new Date(y, m - 1, d);
                    }
                    // Try Date parse
                    const d = new Date(val);
                    return isNaN(d.getTime()) ? null : d;
                },

                // Event handlers
                onCalendarChange(event) {
                    const detail = event?.detail ?? event?.target?.value ?? event;
                    const parsed = this.parseDateMaybe(detail?.value ?? detail);
                    if (parsed) {
                        this.selectedDate = parsed;
                        this.selectedDateString = this.toYmd(parsed);
                        this.showCalendar = false;
                        this.emit();
                    }
                },
                // With x-model on radios, native selection drives both UI and state
                onSearchInput(e) {
                    this.selectedText = e.target.value ?? '';
                    this.emit();
                },
                onFormReset(_e) {
                    // Allow native reset first, then sync Alpine state
                    queueMicrotask(() => {
                        this.selectedText = '';
                        this.selectedStatus = null;
                        const now = new Date();
                        this.selectedDate = now; // keep showing today after reset
                        this.selectedDateString = ''; // but disable date filter
                        this.emit();
                    });
                },
                emit() {
                    const detail = {
                        date: this.selectedDateString,
                        status: this.selectedStatus,
                        text: this.selectedText,
                    };
                    // Build query string for HTMX request
                    const params = new URLSearchParams();
                    if (detail.text && detail.text.trim().length) params.append('search', detail.text.trim());
                    if (detail.date && detail.date.trim().length) params.append('date', detail.date.trim());
                    if (detail.status && detail.status.trim().length) params.append('status', detail.status.trim());
                    // Find the table container to update
                    const target = document.querySelector('.overflow-x-auto');
                    if (target) {
                        // Send HTMX request to the trips filter endpoint
                        htmx.ajax('GET', '{% url "table_htmx" %}?' + params.toString(), {
                            target: target,
                            swap: 'innerHTML',
                            indicator: '.htmx-indicator'
                        });
                    }
                    // Bubble so parents (e.g., page or container) can listen
                    this.$root.dispatchEvent(new CustomEvent('trip-filter:change', {
                        detail,
                        bubbles: true,
                    }));
                },
            }
        }
    </script>
</div>
