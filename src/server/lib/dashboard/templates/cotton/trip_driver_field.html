<fieldset id="driver-block"
          class="fieldset w-full rounded-box border border-base-300 bg-base-100 px-4 !pt-2 !pb-5">
    <legend class="fieldset-legend text-xl font-extrabold">
        Driver Summary
    </legend>
    <div class="form-control w-full mb-4 relative"
         x-data="driverSearch()"
         x-init="bindHtmx()"
         @click.outside="close()">
        <input type="text"
               name="query"
               placeholder="Search Drivers..."
               class="input input-bordered w-full"
               hx-get="{% url 'trip_driver_field_search' %}"
               hx-trigger="keyup changed delay:300ms, search"
               hx-target="#driver-search-results"
               hx-swap="innerHTML"
               x-model="queryText"
               @focus="open()"
               @input.debounce.150ms="open()"
               @keydown.escape.prevent="close()" />
        <!-- This div will be populated by the HTMX response -->
        <div id="driver-search-results"
             x-ref="results"
             x-show="showDriverResults"
             x-cloak
             class="menu bg-base-100 rounded-box shadow-lg absolute w-full z-20 mt-2 border border-base-300">
        </div>
    </div>
    <!-- Driver summary swap region -->
    <div id="driver-summary-card"
         class="contents">
        <!-- Driver Card -->
        <div class="flex h-full w-full flex-col justify-around gap-2 rounded-3xl bg-neutral text-neutral-content p-4">
            <!-- First Row -->
            <div class="flex w-1/3 flex-row justify-between">
                <!-- Rider Avatar -->
                <div class="avatar">
                    <div class="h-18 w-18 rounded-full">
                        <img src="{{ driver_avatar }}"
                             alt="Driver avatar"
                             width="72"
                             height="72" />
                    </div>
                </div>
            </div>
            <!-- Second Row -->
            <div class="w-1/3 text-xl font-semibold">
                <!-- Driver Name -->
                {{ driver_name }}
            </div>
            <!-- Third Row -->
            <div class="-mt-3 w-1/3">
                <!-- Driver Identifier -->
                {{ driver_identifier }}
            </div>
            <!-- Fourth Row -->
            <div class="w-1/3 btn btn-info font-semibold btn-xs">
                <!-- Driver Phone -->
                {{ driver_phone }}
            </div>
        </div>
        <div class="pt-4 pl-3 relative flex w-full min-w-1/2 flex-col gap-2">
            <div class="right-0 flex flex-col items-center justify-center md:absolute md:bottom-14">
                <div class="w-fit">
                    <img src="{{ vehicle_img }}"
                         width="auto"
                         height="auto"
                         alt="Make logo"
                         class="h-56 w-md object-contain" />
                    <img src="{{ vehicle_make_img }}"
                         width="auto"
                         height="auto"
                         alt="Make logo"
                         class="h-14 w-full object-contain" />
                </div>
            </div>
            <div class="text-lg font-light uppercase font-stretch-110%">
                {{ vehicle_year }} {{ vehicle_make }} {{ vehicle_model }}
            </div>
            <div class="font-mono font-bold">
                {{ vehicle_id }} {{ vehicle_plate }}
            </div>
            <div class="flex flex-row gap-4">
                <div class="flex flex-row gap-1">
                    <div class="text-lg">
                        {{ vehicle_wheelchair_capacity }}
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         height="24px"
                         viewBox="0 -960 960 960"
                         width="24px"
                         fill="currentColor">
                        <path d="M480-720q-33 0-56.5-23.5T400-800q0-33 23.5-56.5T480-880q33 0 56.5 23.5T560-800q0 33-23.5 56.5T480-720ZM680-80v-200H480q-33 0-56.5-23.5T400-360v-240q0-33 23.5-56.5T480-680q24 0 41.5 10.5T559-636q55 66 99.5 90.5T760-520v80q-53 0-107-23t-93-55v138h120q33 0 56.5 23.5T760-300v220h-80Zm-280 0q-83 0-141.5-58.5T200-280q0-72 45.5-127T360-476v82q-35 14-57.5 44.5T280-280q0 50 35 85t85 35q39 0 69.5-22.5T514-240h82q-14 69-69 114.5T400-80Z" />
                    </svg>
                </div>
                <div class="flex flex-row gap-1">
                    <div class="text-lg">
                        {{ vehicle_seated_capacity }}
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         height="24px"
                         viewBox="http://www.w3.org/2000/svg"
                         width="24px"
                         fill="currentColor">
                        <path d="M340-720q-33 0-56.5-23.5T260-800q0-33 23.5-56.5T340-880q33 0 56.5 23.5T420-800q0 33-23.5 56.5T340-720Zm220 560H302q-33 0-60.5-23.5T207-240l-87-440h82l88 440h270v80Zm220 80L664-280H386q-29 0-50.5-17.5T308-344l-44-214q-11-48 22.5-85t81.5-37q35 0 63.5 21t36.5 57l44 202h130q21 0 39 11t29 29l140 240-70 40Z" />
                    </svg>
                </div>
            </div>
            <div class="mt-2 btn btn-soft">
                See Driver Details
            </div>
        </div>
    </div>
</fieldset>
<script>
    // Alpine.js component to manage Driver search suggestions visibility,
    // mirroring the control flow used in trip_route_field (showOrigin/showDestination)
    function driverSearch() {
        return {
            // Mirror route field pattern with a bound text value
            queryText: '',
            showDriverResults: false,

            open() {
                this.showDriverResults = true;
            },

            close() {
                // Hide suggestions and clear input so placeholder is shown
                this.showDriverResults = false;
                this.queryText = '';
                // Optional: clear results container content to avoid stale entries
                if (this.$refs.results) this.$refs.results.innerHTML = '';
            },

            // Keep visibility in sync with HTMX swaps (open when content exists, close if empty)
            bindHtmx() {
                const resultsEl = this.$refs.results;
                if (!resultsEl) return;
                const updateVisibilityFromContent = () => {
                    // If there is any non-whitespace content or at least one child, show it
                    const hasContent = (resultsEl.textContent || '').trim().length > 0 || resultsEl.children.length > 0;
                    this.showDriverResults = hasContent;
                };

                // After HTMX swaps content into the results container
                resultsEl.addEventListener('htmx:afterSwap', (e) => {
                    if (e.target === resultsEl) updateVisibilityFromContent();
                });

                // Also handle errors/settle as a fallback
                resultsEl.addEventListener('htmx:afterSettle', (e) => {
                    if (e.target === resultsEl) updateVisibilityFromContent();
                });

                // Close suggestions only after the driver card is swapped successfully
                window.addEventListener('htmx:afterSwap', (e) => {
                    try {
                        const tgt = e?.detail?.target;
                        if (tgt && tgt.id === 'driver-summary-card') {
                            this.close();
                        }
                    } catch (_) {}
                });
            },
        };
    }
</script>
